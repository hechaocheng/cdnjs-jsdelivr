"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,l=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(l=(n<3?i(l):3<n?i(t,o,l):i(t,o))||l);return 3<n&&l&&Object.defineProperty(t,o,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../../context/context"),rowNode_1=require("../../entities/rowNode"),gridOptionsWrapper_1=require("../../gridOptionsWrapper"),selectionController_1=require("../../selectionController"),eventService_1=require("../../eventService"),columnController_1=require("../../columnController/columnController"),utils_1=require("../../utils"),FlattenStage=function(){function e(){}return e.prototype.execute=function(e){var t=e.rowNode,o=[],r={value:0},i=this.columnController.isPivotMode(),n=i&&t.leafGroup,l=n?[t]:t.childrenAfterSort;return this.recursivelyAddToRowsToDisplay(l,o,r,i,0),!n&&this.gridOptionsWrapper.isGroupIncludeTotalFooter()&&(this.ensureFooterNodeExists(t),this.addRowNodeToRowsToDisplay(t.sibling,o,r,0)),o},e.prototype.recursivelyAddToRowsToDisplay=function(e,t,o,r,i){if(!utils_1._.missingOrEmpty(e))for(var n=this.gridOptionsWrapper.isGroupSuppressRow(),l=this.gridOptionsWrapper.isGroupHideOpenParents(),s=this.gridOptionsWrapper.isGroupRemoveSingleChildren(),d=!s&&this.gridOptionsWrapper.isGroupRemoveLowestSingleChildren(),a=0;a<e.length;a++){var p,c,u,_=e[a],f=_.hasChildren(),h=n&&f,v=r&&!f,w=s&&f&&1===_.childrenAfterGroup.length,g=d&&f&&_.leafGroup&&1===_.childrenAfterGroup.length,y=r&&_.leafGroup,x=l&&_.expanded&&!y;!(v||h||x||w||g)&&this.addRowNodeToRowsToDisplay(_,t,o,i),r&&_.leafGroup||(f?(p=w||g,(_.expanded||p)&&(c=p?i:i+1,this.recursivelyAddToRowsToDisplay(_.childrenAfterSort,t,o,r,c),this.gridOptionsWrapper.isGroupIncludeFooter()&&(this.ensureFooterNodeExists(_),this.addRowNodeToRowsToDisplay(_.sibling,t,o,i)))):_.master&&_.expanded&&(u=this.createDetailNode(_),this.addRowNodeToRowsToDisplay(u,t,o,i)))}},e.prototype.addRowNodeToRowsToDisplay=function(e,t,o,r){t.push(e);var i=this.gridOptionsWrapper.isGroupMultiAutoColumn();e.setUiLevel(i?0:r)},e.prototype.ensureFooterNodeExists=function(t){var o;utils_1._.exists(t.sibling)||(o=new rowNode_1.RowNode,this.context.wireBean(o),Object.keys(t).forEach(function(e){o[e]=t[e]}),o.footer=!0,o.rowTop=null,o.oldRowTop=null,utils_1._.exists(o.id)&&(o.id="rowGroupFooter_"+o.id),(o.sibling=t).sibling=o)},e.prototype.createDetailNode=function(e){if(utils_1._.exists(e.detailNode))return e.detailNode;var t=new rowNode_1.RowNode;return this.context.wireBean(t),t.detail=!0,t.selectable=!1,t.flower=t.detail,t.parent=e,utils_1._.exists(e.id)&&(t.id="detail_"+e.id),t.data=e.data,t.level=e.level+1,e.detailNode=t,e.childFlower=e.detailNode,t},__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.Autowired("selectionController"),__metadata("design:type",selectionController_1.SelectionController)],e.prototype,"selectionController",void 0),__decorate([context_1.Autowired("eventService"),__metadata("design:type",eventService_1.EventService)],e.prototype,"eventService",void 0),__decorate([context_1.Autowired("context"),__metadata("design:type",context_1.Context)],e.prototype,"context",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),e=__decorate([context_1.Bean("flattenStage")],e)}();exports.FlattenStage=FlattenStage;