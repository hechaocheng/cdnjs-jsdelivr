"use strict";var __decorate=this&&this.__decorate||function(e,o,r,t){var n,i=arguments.length,l=i<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,o,r,t);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(l=(i<3?n(l):3<i?n(o,r,l):n(o,r))||l);return 3<i&&l&&Object.defineProperty(o,r,l),l},__metadata=this&&this.__metadata||function(e,o){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,o)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),columnController_1=require("../columnController/columnController"),constants_1=require("../constants"),selectionController_1=require("../selectionController"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),displayedGroupCreator_1=require("../columnController/displayedGroupCreator"),columnFactory_1=require("../columnController/columnFactory"),groupInstanceIdCreator_1=require("../columnController/groupInstanceIdCreator"),columnGroup_1=require("../entities/columnGroup"),pinnedRowModel_1=require("../rowModels/pinnedRowModel"),utils_1=require("../utils"),BaseGridSerializingSession=function(){function e(e){var o=e.columnController,r=e.valueService,t=e.gridOptionsWrapper,n=e.processCellCallback,i=e.processHeaderCallback,l=e.cellAndHeaderEscaper;this.columnController=o,this.valueService=r,this.gridOptionsWrapper=t,this.processCellCallback=n,this.processHeaderCallback=i,this.cellAndHeaderEscaper=l}return e.prototype.extractHeaderValue=function(e){var o=this.getHeaderName(this.processHeaderCallback,e);return null==o&&(o=""),this.cellAndHeaderEscaper?this.cellAndHeaderEscaper(o):o},e.prototype.extractRowCellValue=function(e,o,r,t){var n=0<this.columnController.getRowGroupColumns().length,i=t&&t.group&&n&&0===o?this.createValueForGroupNode(t):this.valueService.getValue(e,t);return null==(i=this.processCell(t,e,i,this.processCellCallback,r))&&(i=""),this.cellAndHeaderEscaper?this.cellAndHeaderEscaper(i):i},e.prototype.getHeaderName=function(e,o){return e?e({column:o,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext()}):this.columnController.getDisplayNameForColumn(o,"csv",!0)},e.prototype.createValueForGroupNode=function(e){for(var o=[e.key];e.parent;)e=e.parent,o.push(e.key);return o.reverse().join(" -> ")},e.prototype.processCell=function(e,o,r,t,n){return t?t({column:o,node:e,value:r,api:this.gridOptionsWrapper.getApi(),columnApi:this.gridOptionsWrapper.getColumnApi(),context:this.gridOptionsWrapper.getContext(),type:n}):r},e}();exports.BaseGridSerializingSession=BaseGridSerializingSession;var RowType,GridSerializer=function(){function e(){}return e.prototype.serialize=function(n,e){var o,r,t,i=e&&e.skipGroups,l=e&&e.skipHeader,a=e&&e.columnGroups,p=e&&e.skipFooters,s=e&&e.skipPinnedTop,d=e&&e.skipPinnedBottom,c=e&&e.customHeader,u=e&&e.customFooter,C=e&&e.allColumns,h=e&&e.onlySelected,_=e&&e.columnKeys,m=e&&e.onlySelectedAllPages,g=e&&e.shouldRowBeSkipped||function(){return!1},y=this.gridOptionsWrapper.getApi(),f=this.gridOptionsWrapper.isGroupRemoveSingleChildren(),w=this.gridOptionsWrapper.isGroupRemoveLowestSingleChildren(),G=this.gridOptionsWrapper.getContext(),v=this.columnController.isPivotMode(),A=this.rowModel.getType()===constants_1.Constants.ROW_MODEL_TYPE_CLIENT_SIDE,R=!A&&h,O=[];function E(r){var t,e=w&&r.leafGroup,o=1===r.allChildrenCount&&(f||e);r.group&&(i||o)||p&&r.footer||h&&!r.isSelected()||s&&"top"===r.rowPinned||d&&"bottom"===r.rowPinned||-1===r.level&&!r.leafGroup||g({node:r,api:y,context:G})||(t=n.onNewBodyRow(),O.forEach(function(e,o){t.onColumn(e,o,r)}))}return O=utils_1._.existsAndNotEmpty(_)?this.columnController.getGridColumns(_):C&&!v?(O=this.gridOptionsWrapper.isTreeData()?this.columnController.getGridColumns([constants_1.Constants.GROUP_AUTO_COLUMN_ID]):[]).concat(this.columnController.getAllPrimaryColumns()||[]):this.columnController.getAllDisplayedColumns(),c&&n.addCustomHeader(c),n.prepare(O),a&&(o=new groupInstanceIdCreator_1.GroupInstanceIdCreator,r=this.displayedGroupCreator.createDisplayedGroups(O,this.columnController.getGridBalancedTree(),o,null),this.recursivelyAddHeaderGroups(r,n)),l||(t=n.onNewHeaderRow(),O.forEach(function(e,o){t.onColumn(e,o,void 0)})),this.pinnedRowModel.forEachPinnedTopRow(E),v?this.rowModel.forEachPivotNode?this.rowModel.forEachPivotNode(E):this.rowModel.forEachNode(E):m||R?this.selectionController.getSelectedNodes().forEach(function(e){E(e)}):A?this.rowModel.forEachNodeAfterFilterAndSort(E):this.rowModel.forEachNode(E),this.pinnedRowModel.forEachPinnedBottomRow(E),u&&n.addCustomFooter(u),n.parse()},e.prototype.recursivelyAddHeaderGroups=function(e,o){var r=[];e.forEach(function(e){e.getChildren&&e.getChildren().forEach(function(e){return r.push(e)})}),0<e.length&&e[0]instanceof columnGroup_1.ColumnGroup&&this.doAddHeaderHeader(o,e),r&&0<r.length&&this.recursivelyAddHeaderGroups(r,o)},e.prototype.doAddHeaderHeader=function(e,o){var t=this,n=e.onNewHeaderGroupingRow(),i=0;o.forEach(function(e){var o=e,r=t.columnController.getDisplayNameForColumnGroup(o,"header");n.onColumn(r||"",i++,o.getLeafColumns().length-1)})},__decorate([context_1.Autowired("displayedGroupCreator"),__metadata("design:type",displayedGroupCreator_1.DisplayedGroupCreator)],e.prototype,"displayedGroupCreator",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("rowModel"),__metadata("design:type",Object)],e.prototype,"rowModel",void 0),__decorate([context_1.Autowired("pinnedRowModel"),__metadata("design:type",pinnedRowModel_1.PinnedRowModel)],e.prototype,"pinnedRowModel",void 0),__decorate([context_1.Autowired("selectionController"),__metadata("design:type",selectionController_1.SelectionController)],e.prototype,"selectionController",void 0),__decorate([context_1.Autowired("columnFactory"),__metadata("design:type",columnFactory_1.ColumnFactory)],e.prototype,"columnFactory",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),e=__decorate([context_1.Bean("gridSerializer")],e)}();exports.GridSerializer=GridSerializer,function(e){e[e.HEADER_GROUPING=0]="HEADER_GROUPING",e[e.HEADER=1]="HEADER",e[e.BODY=2]="BODY"}(RowType=exports.RowType||(exports.RowType={}));