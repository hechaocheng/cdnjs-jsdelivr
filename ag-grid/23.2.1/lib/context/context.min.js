"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils_1=require("../utils"),Context=function(){function t(t,e){var n;this.beanWrappers={},this.registeredModules=[],this.componentsMappedByName={},this.destroyed=!1,t&&t.beans&&(this.contextParams=t,this.registeredModules=t.registeredModules,this.logger=e,this.logger.log(">> creating ag-Application Context"),this.setupComponents(),this.createBeans(),n=this.getBeanInstances(),this.wireBeans(n),this.logger.log(">> ag-Application Context ready - component is alive"))}return t.prototype.getBeanInstances=function(){return utils_1._.mapObject(this.beanWrappers,function(t){return t.beanInstance})},t.prototype.setupComponents=function(){var e=this;this.contextParams.components&&this.contextParams.components.forEach(function(t){return e.addComponent(t)})},t.prototype.addComponent=function(t){var e=t.componentName.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().toUpperCase();this.componentsMappedByName[e]=t.theClass},t.prototype.createComponentFromElement=function(t,e){var n=t.nodeName;if(this.componentsMappedByName&&this.componentsMappedByName[n]){var o=new this.componentsMappedByName[n];return this.wireBean(o,e),o}return null},t.prototype.wireBean=function(t,e){if(!t)throw Error("Can't wire to bean since it is null");this.wireBeans([t],e)},t.prototype.wireBeans=function(t,e){this.autoWireBeans(t),this.methodWireBeans(t),this.callLifeCycleMethods(t,"preConstructMethods"),utils_1._.exists(e)&&t.forEach(e),this.callLifeCycleMethods(t,"postConstructMethods")},t.prototype.createBeans=function(){var a=this;this.contextParams.beans.forEach(this.createBeanWrapper.bind(this)),this.contextParams.overrideBeans&&this.contextParams.overrideBeans.forEach(this.createBeanWrapper.bind(this)),utils_1._.iterateObject(this.beanWrappers,function(t,e){var n;e.bean.__agBeanMetaData&&e.bean.__agBeanMetaData.autowireMethods&&e.bean.__agBeanMetaData.autowireMethods.agConstructor&&(n=e.bean.__agBeanMetaData.autowireMethods.agConstructor);var o=a.getBeansForParameters(n,e.bean.name),r=applyToConstructor(e.bean,o);e.beanInstance=r,a.logger.log("bean "+a.getBeanName(r)+" created")})},t.prototype.createBeanWrapper=function(t){var e,n,o=t.__agBeanMetaData;o?(e={bean:t,beanInstance:null,beanName:o.beanName},this.beanWrappers[o.beanName]=e):(n=void 0,n=t.prototype.constructor?t.prototype.constructor.name:""+t,console.error("context item "+n+" is not a bean"))},t.prototype.autoWireBeans=function(t){var r=this;t.forEach(function(o){r.forEachMetaDataInHierarchy(o,function(t,n){var e=t.agClassAttributes;e&&e.forEach(function(t){var e=r.lookupBeanInstance(n,t.beanName,t.optional);o[t.attributeName]=e})})})},t.prototype.methodWireBeans=function(t){var a=this;t.forEach(function(r){a.forEachMetaDataInHierarchy(r,function(t,o){utils_1._.iterateObject(t.autowireMethods,function(t,e){var n;"agConstructor"!==t&&(n=a.getBeansForParameters(e,o),r[t].apply(r,n))})})})},t.prototype.forEachMetaDataInHierarchy=function(t,e){for(var n=Object.getPrototypeOf(t);null!=n;){var o=n.constructor;o.hasOwnProperty("__agBeanMetaData")&&e(o.__agBeanMetaData,this.getBeanName(o)),n=Object.getPrototypeOf(n)}},t.prototype.getBeanName=function(t){if(t.__agBeanMetaData&&t.__agBeanMetaData.beanName)return t.__agBeanMetaData.beanName;var e=t.toString();return e.substring(9,e.indexOf("("))},t.prototype.getBeansForParameters=function(t,o){var r=this,a=[];return t&&utils_1._.iterateObject(t,function(t,e){var n=r.lookupBeanInstance(o,e);a[Number(t)]=n}),a},t.prototype.lookupBeanInstance=function(t,e,n){if(void 0===n&&(n=!1),"context"===e)return this;if(this.contextParams.seed&&this.contextParams.seed.hasOwnProperty(e))return this.contextParams.seed[e];var o=this.beanWrappers[e];return o?o.beanInstance:(n||console.error("ag-Grid: unable to find bean reference "+e+" while initialising "+t),null)},t.prototype.callLifeCycleMethods=function(t,o){var e=this;t.forEach(function(n){e.forEachMetaDataInHierarchy(n,function(t){var e=t[o];e&&e.forEach(function(t){return n[t]()})})})},t.prototype.getBean=function(t){return this.lookupBeanInstance("getBean",t,!0)},t.prototype.getEnterpriseDefaultComponents=function(){return this.contextParams.enterpriseDefaultComponents},t.prototype.destroy=function(){var t;this.destroyed||(this.logger.log(">> Shutting down ag-Application Context"),t=this.getBeanInstances(),this.callLifeCycleMethods(t,"preDestroyMethods"),this.contextParams.seed=null,this.destroyed=!0,this.logger.log(">> ag-Application Context shut down - component is dead"))},t.prototype.isModuleRegistered=function(t){return-1!==this.registeredModules.indexOf(t)},t}();function applyToConstructor(t,e){var n=[null].concat(e);return new(t.bind.apply(t,n))}function PreConstruct(t,e,n){var o=getOrCreateProps(t.constructor);o.postConstructMethods||(o.preConstructMethods=[]),o.preConstructMethods.push(e)}function PostConstruct(t,e,n){var o=getOrCreateProps(t.constructor);o.postConstructMethods||(o.postConstructMethods=[]),o.postConstructMethods.push(e)}function PreDestroy(t,e,n){var o=getOrCreateProps(t.constructor);o.preDestroyMethods||(o.preDestroyMethods=[]),o.preDestroyMethods.push(e)}function Bean(e){return function(t){getOrCreateProps(t).beanName=e}}function Autowired(o){return function(t,e,n){autowiredFunc(t,o,!1,t,e,null)}}function Optional(o){return function(t,e,n){autowiredFunc(t,o,!0,t,e,null)}}function autowiredFunc(t,e,n,o,r,a){var s;null!==e?"number"!=typeof a?((s=getOrCreateProps(t.constructor)).agClassAttributes||(s.agClassAttributes=[]),s.agClassAttributes.push({attributeName:r,beanName:e,optional:n})):console.error("ag-Grid: Autowired should be on an attribute"):console.error("ag-Grid: Autowired name should not be null")}function Qualifier(s){return function(t,e,n){var o,r,a="function"==typeof t?t:t.constructor;"number"==typeof n&&(r=void 0,r=e?(o=getOrCreateProps(a),e):(o=getOrCreateProps(a),"agConstructor"),o.autowireMethods||(o.autowireMethods={}),o.autowireMethods[r]||(o.autowireMethods[r]={}),o.autowireMethods[r][n]=s)}}function getOrCreateProps(t){return t.hasOwnProperty("__agBeanMetaData")||(t.__agBeanMetaData={}),t.__agBeanMetaData}exports.Context=Context,exports.PreConstruct=PreConstruct,exports.PostConstruct=PostConstruct,exports.PreDestroy=PreDestroy,exports.Bean=Bean,exports.Autowired=Autowired,exports.Optional=Optional,exports.Qualifier=Qualifier;