"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,l=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(l=(i<3?n(l):3<i?n(t,r,l):n(t,r))||l);return 3<i&&l&&Object.defineProperty(t,r,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var context_1=require("../context/context"),logger_1=require("../logger"),columnController_1=require("../columnController/columnController"),column_1=require("../entities/column"),utils_1=require("../utils"),dragAndDropService_1=require("../dragAndDrop/dragAndDropService"),gridOptionsWrapper_1=require("../gridOptionsWrapper"),MoveColumnController=function(){function e(e,t){this.needToMoveLeft=!1,this.needToMoveRight=!1,this.pinned=e,this.eContainer=t,this.centerContainer=!utils_1._.exists(e)}return e.prototype.registerGridComp=function(e){this.gridPanel=e},e.prototype.init=function(){this.logger=this.loggerFactory.create("MoveColumnController")},e.prototype.getIconName=function(){return this.pinned?dragAndDropService_1.DragAndDropService.ICON_PINNED:dragAndDropService_1.DragAndDropService.ICON_MOVE},e.prototype.onDragEnter=function(e){var t,r,o=e.dragItem.columns;e.dragSource.type===dragAndDropService_1.DragSourceType.ToolPanel?this.setColumnsVisible(o,!0,"uiColumnDragged"):(t=e.dragItem.visibleState,r=o.filter(function(e){return t[e.getId()]}),this.setColumnsVisible(r,!0,"uiColumnDragged")),this.setColumnsPinned(o,this.pinned,"uiColumnDragged"),this.onDragging(e,!0)},e.prototype.onDragLeave=function(e){var t;this.gridOptionsWrapper.isSuppressDragLeaveHidesColumns()||e.fromNudge||(t=e.dragSource.dragItemCallback().columns,this.setColumnsVisible(t,!1,"uiColumnDragged")),this.ensureIntervalCleared()},e.prototype.setColumnsVisible=function(e,t,r){var o;void 0===r&&(r="api"),e&&(o=e.filter(function(e){return!e.getColDef().lockVisible}),this.columnController.setColumnsVisible(o,t,r))},e.prototype.setColumnsPinned=function(e,t,r){var o;void 0===r&&(r="api"),e&&(o=e.filter(function(e){return!e.getColDef().lockPinned}),this.columnController.setColumnsPinned(o,t,r))},e.prototype.onDragStop=function(){this.ensureIntervalCleared()},e.prototype.normaliseX=function(e){return this.gridOptionsWrapper.isEnableRtl()&&(e=this.eContainer.clientWidth-e),this.centerContainer&&(e+=this.gridPanel.getCenterViewportScrollLeft()),e},e.prototype.checkCenterForScrolling=function(e){var t,r;this.centerContainer&&(r=(t=this.gridPanel.getCenterViewportScrollLeft())+this.gridPanel.getCenterWidth(),this.gridOptionsWrapper.isEnableRtl()?(this.needToMoveRight=e<t+50,this.needToMoveLeft=r-50<e):(this.needToMoveLeft=e<t+50,this.needToMoveRight=r-50<e),this.needToMoveLeft||this.needToMoveRight?this.ensureIntervalStarted():this.ensureIntervalCleared())},e.prototype.onDragging=function(e,t){var r,o,n,i,l=this;void 0===t&&(t=!1),this.lastDraggingEvent=e,utils_1._.missing(e.hDirection)||(r=this.normaliseX(e.x),t||this.checkCenterForScrolling(r),o=this.normaliseDirection(e.hDirection),n=e.dragSource.type,i=(i=e.dragSource.dragItemCallback().columns).filter(function(e){return!e.getColDef().lockPinned||e.getPinned()==l.pinned}),this.attemptMoveColumns(n,i,o,r,t))},e.prototype.normaliseDirection=function(e){if(!this.gridOptionsWrapper.isEnableRtl())return e;switch(e){case dragAndDropService_1.HDirection.Left:return dragAndDropService_1.HDirection.Right;case dragAndDropService_1.HDirection.Right:return dragAndDropService_1.HDirection.Left;default:console.error("ag-Grid: Unknown direction "+e)}},e.prototype.calculateOldIndex=function(e){var t=this.columnController.getAllGridColumns(),r=[];e.forEach(function(e){return r.push(t.indexOf(e))}),utils_1._.sortNumberArray(r);var o=r[0];return utils_1._.last(r)-o!=r.length-1?null:o},e.prototype.attemptMoveColumns=function(e,t,r,o,n){var i=r===dragAndDropService_1.HDirection.Left,l=r===dragAndDropService_1.HDirection.Right,a=this.calculateValidMoves(t,l,o),s=this.calculateOldIndex(t);if(0!==a.length){var d=a[0],c=null!==s&&!n;if(e==dragAndDropService_1.DragSourceType.HeaderCell&&(c=null!==s),c){if(i&&s<=d)return;if(l&&d<=s)return}for(var u=0;u<a.length;u++){var g=a[u];if(this.columnController.doesMovePassRules(t,g))return void this.columnController.moveColumns(t,g,"uiColumnDragged")}}},e.prototype.calculateValidMoves=function(t,e,r){function o(e){return t.indexOf(e)<0}var n,i,l,a=this.columnController.getDisplayedColumns(this.pinned),s=this.columnController.getAllGridColumns(),d=a.filter(function(e){return 0<=t.indexOf(e)}),c=a.filter(o),u=s.filter(o),g=0,p=r;if(e&&(n=0,d.forEach(function(e){return n+=e.getActualWidth()}),p-=n),0<p){for(var h=0;h<c.length;h++){if((p-=c[h].getActualWidth())<0)break;g++}e&&g++}var v=[l=0<g?(i=c[g-1],u.indexOf(i)+1):0];if(e)for(var f=l+1,m=s.length-1;f<=m;)v.push(f),f++;else{for(var f=l,m=s.length-1,_=s[f];f<=m&&this.isColumnHidden(a,_);)f++,v.push(f),_=s[f];f=l-1;for(;0<=f;)v.push(f),f--}return v},e.prototype.isColumnHidden=function(e,t){return e.indexOf(t)<0},e.prototype.ensureIntervalStarted=function(){this.movingIntervalId||(this.intervalCount=0,this.failedMoveAttempts=0,this.movingIntervalId=window.setInterval(this.moveInterval.bind(this),100),this.needToMoveLeft?this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_LEFT,!0):this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_RIGHT,!0))},e.prototype.ensureIntervalCleared=function(){this.moveInterval&&(window.clearInterval(this.movingIntervalId),this.movingIntervalId=null,this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_MOVE))},e.prototype.moveInterval=function(){var e,t,r,o;this.intervalCount++,100<(e=10+5*this.intervalCount)&&(e=100),this.needToMoveLeft?t=this.gridPanel.scrollHorizontally(-e):this.needToMoveRight&&(t=this.gridPanel.scrollHorizontally(e)),0!==t?(this.onDragging(this.lastDraggingEvent),this.failedMoveAttempts=0):(this.failedMoveAttempts++,0<(r=this.lastDraggingEvent.dragItem.columns.filter(function(e){return!e.getColDef().lockPinned})).length&&(this.dragAndDropService.setGhostIcon(dragAndDropService_1.DragAndDropService.ICON_PINNED),7<this.failedMoveAttempts&&(o=this.needToMoveLeft?column_1.Column.PINNED_LEFT:column_1.Column.PINNED_RIGHT,this.setColumnsPinned(r,o,"uiColumnDragged"),this.dragAndDropService.nudge())))},__decorate([context_1.Autowired("loggerFactory"),__metadata("design:type",logger_1.LoggerFactory)],e.prototype,"loggerFactory",void 0),__decorate([context_1.Autowired("columnController"),__metadata("design:type",columnController_1.ColumnController)],e.prototype,"columnController",void 0),__decorate([context_1.Autowired("dragAndDropService"),__metadata("design:type",dragAndDropService_1.DragAndDropService)],e.prototype,"dragAndDropService",void 0),__decorate([context_1.Autowired("gridOptionsWrapper"),__metadata("design:type",gridOptionsWrapper_1.GridOptionsWrapper)],e.prototype,"gridOptionsWrapper",void 0),__decorate([context_1.PostConstruct,__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],e.prototype,"init",null),e}();exports.MoveColumnController=MoveColumnController;